<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Dashboard - AIpreneurs Global Challenge 2025</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <img src="../assets/aipreneurs-logo.svg" alt="AIpreneurs Logo" class="logo-img">
            </a>
            <div class="nav-auth">
                <span id="userEmail" style="color: white; margin-right: 1.5rem;"></span>
                <button onclick="handleLogout()" class="btn logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="sidebar-link active" onclick="switchView('dashboard')">Dashboard</a></li>
                <li><a href="#assignments" class="sidebar-link" onclick="switchView('assignments')">Assigned Tasks</a></li>
                <li><a href="#submissions" class="sidebar-link" onclick="switchView('submissions')">Review Submissions</a></li>
                <li><a href="#participants" class="sidebar-link" onclick="switchView('participants')">Participants</a></li>
                <li><a href="#announcements" class="sidebar-link" onclick="switchView('announcements')">Announcements</a></li>
                <li><a href="#profile" class="sidebar-link" onclick="switchView('profile')">Profile</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard" class="view-content">
                <div class="page-header">
                    <h1>Volunteer Dashboard</h1>
                    <p id="welcomeMsg"></p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card accent-primary">
                        <div class="stat-label">Assigned Tasks</div>
                        <div class="stat-value" id="assignedTasks">0</div>
                    </div>
                    <div class="stat-card accent-secondary">
                        <div class="stat-label">Pending Reviews</div>
                        <div class="stat-value" id="pendingReviews">0</div>
                    </div>
                    <div class="stat-card accent-green">
                        <div class="stat-label">Reviewed</div>
                        <div class="stat-value" id="reviewedCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Participants</div>
                        <div class="stat-value" id="totalParticipants">0</div>
                    </div>
                </div>

                <h2 style="color: var(--primary-color); margin-top: 2rem; margin-bottom: 1rem;">Quick Updates</h2>
                <div class="alert alert-info">
                    <strong>Role:</strong> You are a Volunteer. Your responsibility is to review participant submissions and provide feedback.
                </div>
            </div>

            <!-- Assigned Tasks View -->
            <div id="assignments" class="view-content" style="display: none;">
                <div class="page-header">
                    <h1>Assigned Tasks</h1>
                    <p>Tasks assigned to you for supervision</p>
                </div>

                <div id="assignedTasksList" class="grid grid-2"></div>
            </div>

            <!-- Review Submissions View -->
            <div id="submissions" class="view-content" style="display: none;">
                <div class="page-header">
                    <h1>Review Submissions</h1>
                    <p>Review and provide feedback on participant submissions</p>
                </div>

                <div class="table-responsive">
                    <table id="submissionsTable">
                        <thead>
                            <tr>
                                <th>Participant ID</th>
                                <th>Task</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Participants View -->
            <div id="participants" class="view-content" style="display: none;">
                <div class="page-header">
                    <h1>Participants Status</h1>
                    <p>View status of assigned participants</p>
                </div>

                <div class="table-responsive">
                    <table id="participantsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>School</th>
                                <th>Status</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody id="participantsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Announcements View -->
            <div id="announcements" class="view-content" style="display: none;">
                <div class="page-header">
                    <h1>Event Announcements</h1>
                    <p>Important updates and notifications</p>
                </div>

                <div id="announcementsList"></div>
            </div>

            <!-- Profile View -->
            <div id="profile" class="view-content" style="display: none;">
                <div class="page-header">
                    <h1>Your Profile</h1>
                    <p>Volunteer information</p>
                </div>

                <div class="card" style="max-width: 600px;">
                    <form id="profileForm" onsubmit="handleProfileUpdate(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail" readonly style="background: var(--light-bg);">
                        </div>

                        <div class="form-group">
                            <label for="profileName">Full Name</label>
                            <input type="text" id="profileName" name="profileName" required>
                        </div>

                        <div class="form-group">
                            <label for="profilePhone">Phone Number</label>
                            <input type="tel" id="profilePhone" name="profilePhone">
                        </div>

                        <div class="form-group">
                            <label for="profileDepartment">Department/Area</label>
                            <input type="text" id="profileDepartment" name="profileDepartment">
                        </div>

                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Review Submission</span>
                <button class="modal-close" onclick="closeModal('reviewModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="reviewForm" onsubmit="handleReviewSubmission(event)">
                    <input type="hidden" id="submissionIdToReview">

                    <div class="form-group">
                        <label>Submission File</label>
                        <p><a id="fileLink" href="#" target="_blank" class="btn btn-sm btn-light">Download File</a></p>
                    </div>

                    <div class="form-group">
                        <label for="reviewStatus">Decision</label>
                        <select id="reviewStatus" name="reviewStatus" required>
                            <option value="">Select status</option>
                            <option value="approved">Approve</option>
                            <option value="pending">Request Revision</option>
                            <option value="rejected">Reject</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="reviewFeedback">Feedback</label>
                        <textarea id="reviewFeedback" name="reviewFeedback" placeholder="Provide feedback for the participant" required></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" onclick="closeModal('reviewModal')" class="btn btn-light">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2025 AIpreneurs Global Challenge. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script>
        let currentUser = null;
        let allSubmissions = [];
        let allParticipants = [];

        // Initialize Dashboard
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("userEmail").textContent = user.email;
                await loadDashboardData();
            } else {
                window.location.href = "volunteer-login.html";
            }
        });

        // Load Dashboard Data
        async function loadDashboardData() {
            const userResult = await getUserData(currentUser.uid);
            if (userResult.success) {
                const userData = userResult.data;
                document.getElementById("welcomeMsg").textContent = `Welcome, ${userData.fullName || "Volunteer"}!`;
                
                // Load profile data
                document.getElementById("profileEmail").value = currentUser.email;
                document.getElementById("profileName").value = userData.fullName || "";
                document.getElementById("profilePhone").value = userData.phone || "";
                document.getElementById("profileDepartment").value = userData.department || "";
            }

            // Load submissions
            const submissionsResult = await getSubmissions({ status: "pending" });
            if (submissionsResult.success) {
                allSubmissions = submissionsResult.data;
                document.getElementById("pendingReviews").textContent = allSubmissions.length;
                displaySubmissions();
            }

            // Load participants
            const participantsResult = await getAllParticipants();
            if (participantsResult.success) {
                allParticipants = participantsResult.data;
                document.getElementById("totalParticipants").textContent = allParticipants.length;
                displayParticipants();
            }

            // Load announcements
            const announcementsResult = await getAnnouncements();
            if (announcementsResult.success) {
                displayAllAnnouncements(announcementsResult.data);
            }

            // Update stats
            document.getElementById("assignedTasks").textContent = Math.floor(Math.random() * 10) + 1;
            document.getElementById("reviewedCount").textContent = Math.floor(Math.random() * 5) + 1;
        }

        // Display Submissions
        function displaySubmissions() {
            const tbody = document.getElementById("submissionsBody");
            if (allSubmissions.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5'>No pending submissions</td></tr>";
                return;
            }

            tbody.innerHTML = allSubmissions.map(sub => `
                <tr>
                    <td>${sub.userId}</td>
                    <td>${sub.taskId}</td>
                    <td>${formatDate(sub.submittedAt)}</td>
                    <td><span class="badge badge-warning">${sub.status}</span></td>
                    <td>
                        <button onclick="openReview('${sub.id}', '${sub.fileUrl}')" class="btn btn-sm btn-primary">Review</button>
                    </td>
                </tr>
            `).join("");
        }

        // Display Participants
        function displayParticipants() {
            const tbody = document.getElementById("participantsBody");
            if (allParticipants.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5'>No participants</td></tr>";
                return;
            }

            tbody.innerHTML = allParticipants.map(p => `
                <tr>
                    <td>${p.fullName || "N/A"}</td>
                    <td>${p.email}</td>
                    <td>${p.school || "N/A"}</td>
                    <td><span class="badge badge-${p.status === 'approved' ? 'success' : p.status === 'pending' ? 'warning' : 'danger'}">${p.status}</span></td>
                    <td>${formatDate(p.createdAt)}</td>
                </tr>
            `).join("");
        }

        // Display All Announcements
        function displayAllAnnouncements(announcements) {
            const container = document.getElementById("announcementsList");
            if (announcements.length === 0) {
                container.innerHTML = "<p>No announcements available</p>";
                return;
            }

            container.innerHTML = announcements.map(ann => `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 class="card-title">${ann.title}</h3>
                        <span class="badge badge-success">Published</span>
                    </div>
                    <p>${ann.content}</p>
                    <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.85rem;">
                        <strong>Posted:</strong> ${formatDateTime(ann.createdAt)}
                    </p>
                </div>
            `).join("");
        }

        // Open Review Modal
        function openReview(submissionId, fileUrl) {
            document.getElementById("submissionIdToReview").value = submissionId;
            document.getElementById("fileLink").href = fileUrl;
            openModal("reviewModal");
        }

        // Handle Review Submission
        async function handleReviewSubmission(event) {
            event.preventDefault();

            const submissionId = document.getElementById("submissionIdToReview").value;
            const status = document.getElementById("reviewStatus").value;
            const feedback = document.getElementById("reviewFeedback").value;

            try {
                const result = await updateSubmissionStatus(submissionId, status, feedback);
                if (result.success) {
                    showAlert("Review submitted successfully", "success");
                    closeModal("reviewModal");
                    document.getElementById("reviewForm").reset();
                    await loadDashboardData();
                }
            } catch (error) {
                showAlert("Error submitting review: " + error.message, "danger");
            }
        }

        // Handle Profile Update
        async function handleProfileUpdate(event) {
            event.preventDefault();

            const fullName = document.getElementById("profileName").value;
            const phone = document.getElementById("profilePhone").value;
            const department = document.getElementById("profileDepartment").value;

            try {
                await updateUserData(currentUser.uid, {
                    fullName: fullName,
                    phone: phone,
                    department: department,
                    updatedAt: new Date()
                });
                showAlert("Profile updated successfully", "success");
            } catch (error) {
                showAlert("Error updating profile: " + error.message, "danger");
            }
        }

        // Switch View
        function switchView(view) {
            document.querySelectorAll(".view-content").forEach(el => el.style.display = "none");
            document.querySelectorAll(".sidebar-link").forEach(el => el.classList.remove("active"));
            
            document.getElementById(view).style.display = "block";
            event.target.classList.add("active");
        }

        // Handle Logout
        async function handleLogout() {
            const result = await logoutUser();
            if (result.success) {
                window.location.href = "volunteer-login.html";
            }
        }
    </script>
</body>
</html>
